---
title: "STAT423_Project1_Main"
author: "Dante Ramirez"
date: '2023-02-01'
output: html_document
---

```{r setup, warning=FALSE, message=FALSE}

library(tidyverse)
library(Lahman)
library(readr)
library(lubridate)
library(GGally)

# Please create a variable for all datasets below along with a message of what we need it for

# To find career position player numbers
batting_df <- read_csv(file = "Data/Batting2022updated.csv")

# To find career pitcher numbers
pitching_df <- read_csv(file = "Data/PitchingUpdated2022.csv")

# For our response of boolean elected into the hall or not
hall_df <- read_csv(file = "Data/HallOfFameUpdated2022.csv")

# For the WS win column
team_df <- read_csv(file = "Data/TeamsUpdated2022.csv")

# For awards won by players
awards_df <- read_csv(file = "Data/AwardsPlayers.csv")

# For allstar game appearences
allstar_df <- read_csv(file = "Data/AllstarFull.csv")

# Preleminary PED data frames
espn_ped_df <- read_csv(file = "Data/suspectedusers_espn.csv")
wiki_ped_df <- read_csv(file = "Data/suspendedlist_wikipedia.csv")

```

```{r combining hof mess, warning=FALSE, message=FALSE}

# Sums counting stats and removes categoricals
batting_df_continuous_counts <- batting_df %>%
  subset(select =-c(2:5)) %>% 
  group_by(playerID) %>%
  summarise(across(everything(), sum))

# Find the mode of most common team and league per player
batting_df_categorical_counts <- batting_df %>%
  subset(select = c(1,4,5)) %>%
  mutate(across(c(1:3), as.factor)) %>%
  group_by(playerID) %>%
  mutate(PrimaryTeam = names(which.max(table(teamID)))) %>%
  mutate(PrimaryLg = names(which.max(table(lgID)))) %>%
  subset(select = c(1, 4, 5)) %>%
  distinct()

# Extract response y/n variable
hall_df_tidy <- hall_df %>%
  group_by(playerID) %>%
  subset(select = c(1, 3, 7, 8)) %>%
  filter(category == "Player")


# Sums counting stats for pitching
pitching_df_continuous_counts <- pitching_df %>%
  subset(select =-c(2:5, 19)) %>%
  group_by(playerID) %>%
  summarize(across(everything(), sum)) %>%
  mutate(ERA = round(ER / IPouts * 27, 2),
         WHIP = round((BB + H) / IPouts * 3, 2))

# Find the mode of most common team and league per pitcher
pitching_df_categorical_counts <- pitching_df %>%
  subset(select = c(1,4,5)) %>%
  mutate(across(c(1:3), as.factor)) %>%
  group_by(playerID) %>%
  mutate(PrimaryTeam = names(which.max(table(teamID)))) %>%
  mutate(PrimaryLg = names(which.max(table(lgID)))) %>%
  subset(select = c(1, 4, 5)) %>%
  distinct()

# Unique HOF inducted and non-inducted players
hof_players <- hall_df %>% 
  filter(category == "Player") %>% 
  group_by(playerID) %>%
  summarize(wein = "Y" %in% inducted * 1)

# Unique award winners -- columns represent different rewards
awards_wider <- awards_df %>% 
  mutate(award_id_clean = str_replace_all(str_replace_all(str_to_lower(awardID), " ", "_"), "-", "_")) %>% 
  group_by(playerID, award_id_clean) %>% 
  summarize(n = n()) %>%
  pivot_wider(id_cols = playerID, names_from = award_id_clean, values_from = n) %>% 
  mutate(across(1:29, ~ replace_na(.x, 0)))

# For player name, debute, and playerID conversion
player_df <- read_csv(file = "Data/People2022.csv")

# Main Pitcher data frame to preform analysis on
PitcherHOF_df <- inner_join(pitching_df_continuous_counts,
                                   pitching_df_categorical_counts,
                                   by = "playerID") %>%
  inner_join(awards_wider, by = "playerID") %>%
  inner_join(hof_players, by = "playerID") %>%
  subset(select = -c(35, 37, 45, 55, 57)) %>%
  filter(G > 200) %>%
  inner_join(player_df[, c(1, 25)], by = "playerID")

# Main Position Player data frame to preform analysis on
PositionPlayerHOF_df <- inner_join(batting_df_continuous_counts,
                                   batting_df_categorical_counts,
                                   by = "playerID") %>%
  inner_join(awards_wider, by = "playerID") %>%
  inner_join(hof_players, by = "playerID") %>%
  subset(select = c(1:26, 28:30, 34:37, 40:42, 44, 45, 47, 49, 50)) %>%
  mutate(across(c(19, 20, 29, 41), as.factor)) %>%
  filter(!(playerID %in% PitcherHOF_df$playerID)) %>%
  mutate(AVG = round(H / AB, 3), 
         OBP = round((H + BB + HBP) / (AB + ifelse(!is.na(SH), SH, 0) + ifelse(!is.na(SF), SF, 0) + BB + HBP), 3),
         `1B` = H - (`2B` + `3B` + HR),
         SLG = round((`1B` + `2B` * 2 + `3B` * 3 + HR * 4) / AB, 3)) %>%
  inner_join(player_df[, c(1, 25)], by = "playerID")

```

```{r time series mess, warning=FALSE, message=FALSE}

# Below are mainly for time series analysis

# For player name, debute, and playerID conversion
player_df <- read_csv(file = "Data/People2022.csv")

# Creates Player column to ease merging with other df's
player_df <- player_df %>% mutate(Player = str_c(nameFirst,
                                                 nameLast,
                                                 sep = " "))

# For updated pitching data to get accurate innings pitched totals
pitcherTimeSeries_df <- read_csv(file = "Data/Pitching2022.csv")

# vector of playerID's who've played in 2017 or beyond
pitcherTimeSeries_df_2017onwards <- pitcherTimeSeries_df %>%
  group_by(playerID) %>%
  filter(yearID >= 2017) %>% 
  pull(playerID) %>%
  unique()

# Applies vector to main data set and filters, creates IP column
pitcherTimeSeries_df <- pitcherTimeSeries_df %>% 
  filter(playerID %in% pitcherTimeSeries_df_2017onwards) %>%
  mutate(IP = round(IPouts/3, 1))

# Merges Player bio df with median innings pitched df
avg_ip_df <- pitcherTimeSeries_df %>%
  group_by(playerID) %>% 
  summarise_at(vars(IP), list(MedianIP = median)) %>%
  inner_join(player_df, by = "playerID") %>%
  mutate(played2017plus = T)

# For time series pitch frequency covariates
pitch_arsenal_df <- rbind(read_csv(file = "Data/pitch_arsenals_2017.csv"),
                          read_csv(file = "Data/pitch_arsenals_2018.csv"),
                          read_csv(file = "Data/pitch_arsenals_2019.csv"),
                          read_csv(file = "Data/pitch_arsenals_2020.csv"),
                          read_csv(file = "Data/pitch_arsenals_2021.csv"),
                          read_csv(file = "Data/pitch_arsenals_2022.csv"))


# We are making the assumption that players retain primary pitch type prior to the 2017 StatCast season.

# Create universal name variable to join with tommyJohn_df 
pitch_arsenal_df <- pitch_arsenal_df %>% mutate(Player = str_c(first_name,
                                                               last_name,
                                                               sep = " ")) %>%
  group_by(Player) %>%
  summarise_at(vars(n_ff,
                    n_si,
                    n_fc,
                    n_sl,
                    n_ch,
                    n_cu,
                    n_fs), list(mean))

# For dates and player who had Tommy John surgery
tommyJohn_df <- read_csv(file = "Data/Tommy John Surgery List (@MLBPlayerAnalys) - TJ List.csv")

# Gets rid of spaces in col names
names(tommyJohn_df) <- str_replace_all(names(tommyJohn_df),
                                       c(" " = "_" , "," = "" ))

# Merges the TJ, pitch arsenal, player bio, and IP data. Indicates censored
timeseries_df <- full_join(pitch_arsenal_df, tommyJohn_df, by = "Player") %>%
  mutate(TJ_Surgery_Date = mdy(TJ_Surgery_Date)) %>%
  full_join(avg_ip_df, by = "Player") %>%
  filter(played2017plus == T) %>%
  mutate(HadTJ = ifelse(is.na(TJ_Surgery_Date), 0, 1)) %>%
  mutate(Censored = ifelse(HadTJ == "No" & finalGame < "2022-09-01",
                           "Censored",
                           "Non-Censored")) %>%
  mutate(PrimaryPitch = ifelse(n_ff > n_si 
                               & n_ff > n_fc
                               & n_ff > n_sl
                               & n_ff > n_ch
                               & n_ff > n_cu
                               & n_ff > n_fs, "4seamFastball",
                        ifelse(n_si > n_ff 
                               & n_si > n_fc
                               & n_si > n_sl
                               & n_si > n_ch 
                               & n_si > n_cu
                               & n_si > n_fs, "Sinker",
                        ifelse(n_fc > n_ff 
                               & n_fc > n_si 
                               & n_fc > n_sl
                               & n_fc > n_ch
                               & n_fc > n_cu
                               & n_fc > n_fs, "Cutter",
                        ifelse(n_sl > n_ff 
                               & n_sl > n_fc
                               & n_sl > n_si
                               & n_sl > n_ch
                               & n_sl > n_cu
                               & n_sl > n_fs, "Slider",
                        ifelse(n_ch > n_ff
                               & n_ch > n_fc
                               & n_ch > n_sl
                               & n_ch > n_si
                               & n_ch > n_cu
                               & n_ch > n_fs, "Change-up",
                        ifelse(n_cu > n_ff 
                               & n_cu > n_fc
                               & n_cu > n_sl
                               & n_cu > n_ch
                               & n_cu > n_si
                               & n_cu > n_fs, "Curveball",
                        "Splitter"))))))) %>%
  mutate(numDaysUntilTJ = ifelse(!is.na(TJ_Surgery_Date),
                                 TJ_Surgery_Date - debut,
                                 finalGame - debut)) %>%
  filter(is.na(numDaysUntilTJ) == T | numDaysUntilTJ > 0) %>%
  mutate(Fast_Off_Break = ifelse(PrimaryPitch == "4seamFastball"
                           | PrimaryPitch == "Cutter"
                           | PrimaryPitch == "Sinker", "Fastball",
                           ifelse(PrimaryPitch == "Splitter"
                           | PrimaryPitch == "Change-up", "Offspeed", "Breakingball"))) %>%
  filter(!is.na(n_ff))

# Final data frame to be used for analysis
final_time_series_df <- timeseries_df %>%
  select(1, 50, 55, 51, 67, 68, 70, 78, 80, 76, 79)


```

```{r EDA445}

# firstbump?

# Summary Stats, HR by hall of fame status
tapply(PositionPlayerHOF_df$HR, PositionPlayerHOF_df$wein, summary)

# Summary Stats, H by hall of fame status
tapply(PositionPlayerHOF_df$H, PositionPlayerHOF_df$wein, summary)

# Summary Stats, RBI by hall of fame status
tapply(PositionPlayerHOF_df$RBI, PositionPlayerHOF_df$wein, summary)

# Boxplot comparing homerun totals in non-hall of famers to hall of famers
hr_by_HOF <- ggplot(data = PositionPlayerHOF_df,
                    mapping = aes(x = wein, y = HR)) +
  geom_boxplot()

# Boxplot comparing hit totals in non-hall of famers to hall of famers
hits_by_HOF <- ggplot(data = PositionPlayerHOF_df,
                      mapping = aes(x = wein, y = H)) + 
  geom_boxplot()

# Boxplots stratified by number of mvp's, grouped by hof, on number of hr totals 
 ggplot(data = PositionPlayerHOF_df,
                     mapping = aes(x = wein, y = HR, color = most_valuable_player)) + 
  geom_boxplot()

# Pairs plots
pairs(PositionPlayerHOF_df[,c(4, 5, 8, 9, 10, 12, 14, 21, 23, 24, 27, 41)])

```

```{r Cox Proportional Hazards Analysis}

library(survival)
library(timereg)
library(foreign)
library(msm)
library(KMsurv)

# Preliminary analysis of distribution of primary pitches
with(final_time_series_df, table(Fast_Off_Break))

# Preliminary analysis of distribution of primary pitches
with(final_time_series_df, table(PrimaryPitch))

# Of pitchers who threw breaking balls primarily, number who had TJ vs not
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Breakingball" & final_time_series_df$HadTJ == "Yes"])
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Breakingball" & final_time_series_df$HadTJ == "No"])

# Of pitchers who threw Fastballs primarily, number who had TJ vs not
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Fastball" & final_time_series_df$HadTJ == "Yes"])
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Fastball" & final_time_series_df$HadTJ == "No"])

# Of pitchers who threw Offspeed pitches primarily, number who had TJ vs not
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Offspeed" & final_time_series_df$HadTJ == "Yes"])
length(final_time_series_df$numDaysUntilTJ[final_time_series_df$Fast_Off_Break == "Offspeed" & final_time_series_df$HadTJ == "No"])


KM_3pitch <- survfit(Surv(numDaysUntilTJ, HadTJ) ~ Fast_Off_Break,
                     data = final_time_series_df)
print(KM_3pitch)

km_3pitch_plot <- plot(KM_3pitch, col = c("red", "blue", "green"),
                       lwd = 2, xlab = "Time (days)",
                       main = "", ylab = "Survival Probability")

```

